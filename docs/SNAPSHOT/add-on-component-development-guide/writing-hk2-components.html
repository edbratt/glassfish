
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Writing HK2 Components</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
<table id="doc-title" cellspacing="0" cellpadding="0">
  <tr>
  <td align="left" valign="top">
  <b>Writing HK2 Components</b><br />
      <p class="beta">DRAFT</p>
  </td>
  </tr>
</table>
<hr />

<table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>
		<td align="left">
		<a href="introduction.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="extending-the-admin-console.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>


<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a id="GSACG00002"></a><a id="ghmna"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-hk2-components">2 Writing HK2 Components</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Hundred-Kilobyte Kernel (HK2) is the lightweight and extensible
kernel of GlassFish Server. To interact with GlassFish Server, add-on
components plug in to this kernel. In the HK2 component model, the
functions of an add-on component are declared through a contract-service
implementation paradigm. An HK2 contract identifies and describes the
building blocks or the extension points of an application. An HK2
service implements an HK2 contract.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#ghokq">HK2 Component Model</a></p>
</li>
<li>
<p><a href="#ghojt">Services in the HK2 Component Model</a></p>
</li>
<li>
<p><a href="#ghokt">HK2 Runtime</a></p>
</li>
<li>
<p><a href="#ghojb">Inversion of Control</a></p>
</li>
<li>
<p><a href="#ghmoe">Identifying a Class as an Add-On Component</a></p>
</li>
<li>
<p><a href="#ghpvp">Using the Apache Maven Build System to Develop HK2
Components</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="ghokq"></a><a id="GSACG00091"></a><a id="hk2-component-model"></a></p>
</div>
<div class="sect2">
<h3 id="_hk2_component_model">HK2 Component Model</h3>
<div class="paragraph">
<p>The Hundred-Kilobyte Kernel (HK2) provides a module system and component
model for building complex software systems. HK2 forms the core of
GlassFish Server&#8217;s architecture.</p>
</div>
<div class="paragraph">
<p>The module system is responsible for instantiating classes that
constitute the application functionality. The HK2 runtime complements
the module system by creating objects. It configures such objects by:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Injecting other objects that are needed by a newly instantiated object</p>
</li>
<li>
<p>Injecting configuration information needed for that object</p>
</li>
<li>
<p>Making newly created objects available, so that they can then be
injected to other objects that need it</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="ghojt"></a><a id="GSACG00092"></a><a id="services-in-the-hk2-component-model"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_services_in_the_hk2_component_model">Services in the HK2 Component Model</h3>
<div class="paragraph">
<p>An HK2 service identifies the building blocks or the extension points of
an application. A service is a plain-old Java object (POJO) with the
following characteristics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The object implements an interface.</p>
</li>
<li>
<p>The object is declared in a JAR file with the <code>META-INF/services</code>
file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To clearly separate the contract interface and its implementation, the
HK2 runtime requires the following information:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Which interfaces are contracts</p>
</li>
<li>
<p>Which implementations of such interfaces are services</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Interfaces that define a contract are identified by the
<code>org.jvnet.hk2.annotations.Contract</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Retention(RUNTIME)
@Target(TYPE)
public @interface Contract {
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementations of such contracts should be identified with an
<code>org.jvnet.hk2.annotations.Service</code> annotation so that the HK2 runtime
can recognize them as <code>@Contract</code> implementations.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Retention(RUNTIME)
@Target(TYPE)
public @interface Service {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Service.html"><code>Service</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Service.html</code>).</p>
</div>
<div class="paragraph">
<p><a id="ghokt"></a><a id="GSACG00093"></a><a id="hk2-runtime"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_hk2_runtime">HK2 Runtime</h3>
<div class="paragraph">
<p>Once Services are defined, the HK2 runtime can be used to instantiate or
retrieve instances of services. Each service instance has a scope,
specified as singleton, per thread, per application, or a custom scope.</p>
</div>
<div class="paragraph">
<p><a id="ghoib"></a><a id="GSACG00181"></a><a id="scopes-of-services"></a></p>
</div>
<div class="sect3">
<h4 id="_scopes_of_services">Scopes of Services</h4>
<div class="paragraph">
<p>You can specify the scope of a service by adding an
<code>org.jvnet.hk2.annotations.Scoped</code> annotation to the class-level of your
<code>@Service</code> implementation class. Scopes are also services, so they can
be custom defined and added to the HK2 runtime before being used by
other services. Each scope is responsible for storing the service
instances to which it is tied; therefore, the HK2 runtime does not rely
on predefined scopes (although it comes with a few predefined ones).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Contract
public abstract class Scope {
    public abstract ScopeInstance current();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code fragment shows how to set the scope for a service to
the predefined <code>Singleton</code> scope:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Service
public Singleton implements Scope {
    ...
}

@Scope(Singleton.class)
@Service
public class SingletonService implements RandomContract {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can define a new <code>Scope</code> implementation and use that scope on your
<code>@Service</code> implementations. You will see that the HK2 runtime uses the
<code>Scope</code> instance to store and retrieve service instances tied to that
scope.</p>
</div>
<div class="paragraph">
<p><a id="ghoky"></a><a id="GSACG00182"></a><a id="instantiation-of-components-in-hk2"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_instantiation_of_components_in_hk2">Instantiation of Components in HK2</h4>
<div class="paragraph">
<p>Do not call the <code>new</code> method to instantiate components. Instead,
retrieve components by using the <code>Habitat</code> instance. The simplest way to
use the <code>Habitat</code> instance is through a <code>getComponent(Class`T
`contract)</code> call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">public &lt;T&gt; T getComponent(Class&lt;T&gt; clazz) throws ComponentException;</code></pre>
</div>
</div>
<div class="paragraph">
<p>More APIs are available at
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/Habitat.html"><code>Habitat</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/Habitat.html</code>).</p>
</div>
<div class="paragraph">
<p><a id="ghois"></a><a id="GSACG00183"></a><a id="hk2-lifecycle-interfaces"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_hk2_lifecycle_interfaces">HK2 Lifecycle Interfaces</h4>
<div class="paragraph">
<p>Components can attach behaviors to their construction and destruction
events by implementing the
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/PostConstruct.html"><code>org.jvnet.hk2.component.PostConstruct</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/PostConstruct.html</code>)
interface, the
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/PreDestroy.html"><code>org.jvnet.hk2.component.PreDestroy</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/component/PreDestroy.html</code>)
interface, or both. These are interfaces rather than annotations for
performance reasons.</p>
</div>
<div class="paragraph">
<p>The <code>PostConstruct</code> interface defines a single method, <code>postConstruct</code>,
which is called after a component has been initialized and all its
dependencies have been injected.</p>
</div>
<div class="paragraph">
<p>The <code>PreDestroy</code> interface defines a single method, <code>preDestroy</code>, which
is called just before a component is removed from the system.</p>
</div>
<div class="paragraph">
<p><a id="GSACG00014"></a><a id="ghoqv"></a></p>
</div>
<div class="paragraph">
<p>Example 2-1 Example Implementation of <code>PostContruct</code> and <code>PreDestroy</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Service(name="com.example.container.MyContainer")
public class MyContainer implements Container, PostConstruct, PreDestroy {
    @Inject
    Logger logger;
    ...
    public void postConstruct() {
        logger.info("Starting up.");
    }

    public void preDestroy() {
        logger.info("Shutting down.");
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="ghojb"></a><a id="GSACG00094"></a><a id="inversion-of-control"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_inversion_of_control">Inversion of Control</h3>
<div class="paragraph">
<p>Inversion of control (IoC) refers to a style of software architecture
where the behavior of a system is determined by the runtime capabilities
of the individual, discrete components that make up the system. This
architecture is different from traditional styles of software
architecture, where all the components of a system are specified at
design-time. With IoC, discrete components respond to high-level events
to perform actions. While performing these actions, the components
typically rely on other components to provide other actions. In an IoC
system, components use injection to gain access to other components.</p>
</div>
<div class="paragraph">
<p><a id="ghoiz"></a><a id="GSACG00184"></a><a id="injecting-hk2-components"></a></p>
</div>
<div class="sect3">
<h4 id="_injecting_hk2_components">Injecting HK2 Components</h4>
<div class="paragraph">
<p>Services usually rely on other services to perform their tasks. The HK2
runtime identifies the <code>@Contract</code> implementations required by a service
by using the
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Inject.html"><code>org.jvnet.hk2.annotations.Inject</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Inject.html</code>)
annotation. <code>Inject</code> can be placed on fields or setter methods of any
service instantiated by the HK2 runtime. The target service is retrieved
and injected during the calling service&#8217;s instantiation by the component
manager.</p>
</div>
<div class="paragraph">
<p>The following example shows how to use <code>@Inject</code> at the field level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Inject
ConfigService config;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example shows how to use <code>@Inject</code> at the setter level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Inject
public void set(ConfigService svc) {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Injection can further qualify the intended injected service
implementation by using a name and scope from which the service should
be available:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Inject(Scope=Singleton.class, name="deploy")
AdminCommand deployCommand;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="ghoic"></a><a id="GSACG00186"></a><a id="instantiation-cascading-in-hk2"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_instantiation_cascading_in_hk2">Instantiation Cascading in HK2</h4>
<div class="paragraph">
<p>Injection of instances that have not been already instantiated triggers
more instantiation. You can see this as a component instantiation
cascade where some code requests for a high-level service will, by using
the <code>@Inject</code> annotation, require more injection and instantiation of
lower level services. This cascading feature keeps the implementation as
private as possible while relying on interfaces and the separation of
contracts and providers.</p>
</div>
<div class="paragraph">
<p><a id="GSACG00015"></a><a id="ghquz"></a></p>
</div>
<div class="paragraph">
<p>Example 2-2 Example of Instantiation Cascading</p>
</div>
<div class="paragraph">
<p>The following example shows how the instantiation of <code>DeploymentService</code>
as a <code>Startup</code> contract implementation will trigger the instantiation of
the <code>ConfigService</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Contract
public interface Startup {...}

Iterable&lt;Startup&gt; startups;
startups = habitat.getComponents(Startup.class);

@Service
public class DeploymentService implements Startup {
    @Inject
    ConfigService config;
}

@Service
public Class ConfigService implements ... {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="ghmoe"></a><a id="GSACG00095"></a><a id="identifying-a-class-as-an-add-on-component"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_identifying_a_class_as_an_add_on_component">Identifying a Class as an Add-On Component</h3>
<div class="paragraph">
<p>GlassFish Server discovers add-on components by identifying Java
programming language classes that are annotated with the
<code>org.jvnet.hk2.annotation.Service</code> annotation.</p>
</div>
<div class="paragraph">
<p>To identify a class as an implementation of an GlassFish Server service,
add the <code>org.jvnet.hk2.annotations.Service</code> annotation at the
class-definition level of your Java programming language class.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Service
public class SamplePlugin implements ConsoleProvider {
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@Service</code> annotation has the following elements. All elements are
optional.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>name</code></dt>
<dd>
<p>The name of the service. The default value is an empty string.</p>
</dd>
<dt class="hdlist1"><code>scope</code></dt>
<dd>
<p>The scope to which this service implementation is tied. The default
value is <code>org.glassfish.hk2.scopes.PerLookup.class</code>.</p>
</dd>
<dt class="hdlist1"><code>factory</code></dt>
<dd>
<p>The factory class for the service implementation, if the service is
created by a factory class rather than by calling the default
constructor. If this element is specified, the factory component is
activated, and <code>Factory.getObject</code> is used instead of the default
constructor. The default value of the <code>factory</code> element is
<code>org.jvnet.hk2.component.Factory.class</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p><a id="GSACG00016"></a><a id="ghoip"></a></p>
</div>
<div class="paragraph">
<p>Example 2-3 Example of the Optional Elements of the <code>@Service</code>
Annotation</p>
</div>
<div class="paragraph">
<p>The following example shows how to use the optional elements of the
<code>@Service</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">@Service (name="MyService",
    scope=com.example.PerRequest.class,
    factory=com.example.MyCustomFactory)
public class SamplePlugin implements ConsoleProvider {
...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="ghpvp"></a><a id="GSACG00096"></a><a id="using-the-apache-maven-build-system-to-develop-hk2-components"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_using_the_apache_maven_build_system_to_develop_hk2_components">Using the Apache Maven Build System to Develop HK2 Components</h3>
<div class="paragraph">
<p>If you are using Maven 2 to build HK2 components, invoke the
<code>auto-depends</code> plug-in for Maven so that the <code>META-INF/services</code> files
are generated automatically during build time.</p>
</div>
<div class="paragraph">
<p><a id="GSACG00017"></a><a id="ghqsa"></a></p>
</div>
<div class="paragraph">
<p>Example 2-4 Example of the Maven Plug-In Configuration</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">&lt;plugin&gt;
    &lt;groupId&gt;org.glassfish.hk2&lt;/groupId&gt;
    &lt;artifactId&gt;hk2-maven-plugin&lt;/artifactId&gt;
    &lt;configuration&gt;
        &lt;includes&gt;
            &lt;include&gt;com/example/**&lt;/include&gt;
        &lt;/includes&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GSACG00018"></a><a id="ghoik"></a></p>
</div>
<div class="paragraph">
<p>Example 2-5 Example of <code>META-INF/services</code> File Generation</p>
</div>
<div class="paragraph">
<p>This example shows how to use
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Contract.html"><code>@Contract</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Contract.html</code>)
and
<a href="http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Service.html"><code>@Service</code></a>
(<code>http://hk2.java.net/auto-depends/apidocs/org/jvnet/hk2/annotations/Service.html</code>)
and the resulting <code>META-INF/services</code> files.</p>
</div>
<div class="paragraph">
<p>The interfaces and classes in this example are as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">package com.example.wallaby.annotations;
@Contract
public interface Startup {...}

package com.example.wombat;
@Contract
public interface RandomContract {...}

package com.example.wallaby;
@Service
public class MyService implements Startup, RandomContract, PropertyChangeListener {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These interfaces and classes generate this <code>META-INF/services</code> file with
the <code>MyService</code> content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">com.example.wallaby.annotations.Startup
com.example.wombat.RandomContract</code></pre>
</div>
</div>
</div>
</div>
</div>

<hr />

<table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>		
		<td align="left">
		<a href="introduction.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="extending-the-admin-console.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>

<span id="copyright">
        <img src="img/eclipse_foundation_logo_tiny.png" height="20px" alt="Eclipse Foundation Logo" align="top"/>&nbsp;            
        <span >Copyright&nbsp;&copy;&nbsp;2020,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.</span>
</span>

<p align="center" class="beta">DRAFT</p>

</body>
</html>