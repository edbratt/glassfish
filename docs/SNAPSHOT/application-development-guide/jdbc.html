
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Using the JDBC API for Database Access</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="css/style.css" rel="stylesheet">
    <script src="https://use.fontawesome.com/96c4d89611.js"></script>
  </head>
  <body>
<table id="doc-title" cellspacing="0" cellpadding="0">
  <tr>
  <td align="left" valign="top">
  <b>Using the JDBC API for Database Access</b><br />
      <p class="beta">DRAFT</p>
  </td>
  </tr>
</table>
<hr />

<table width="90%" id="top-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>
		<td align="left">
		<a href="part-services-and-apis.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="transaction-service.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class=" vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>


<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><a id="GSDVG00017"></a><a id="beamj"></a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-the-jdbc-api-for-database-access">14 Using the JDBC API for Database Access</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter describes how to use the Java Database Connectivity (JDBC)
API for database access with the Oracle GlassFish Server. This chapter
also provides high level JDBC implementation instructions for servlets
and EJB components using the GlassFish Server.</p>
</div>
<div class="paragraph">
<p>The JDBC specifications are available at
<code>http://www.oracle.com/technetwork/java/javase/jdbc/index.html</code>.</p>
</div>
<div class="paragraph">
<p>A useful JDBC tutorial is located at
<code>http://docs.oracle.com/javase/tutorial/jdbc/index.html</code>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>The GlassFish Server does not support connection pooling or transactions
for an application&#8217;s database access if it does not use standard Java EE
<code>DataSource</code> objects.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#giyck">Statements</a></p>
</li>
<li>
<p><a href="#giyeq">Connections</a></p>
</li>
<li>
<p><a href="#giyde">Connection Wrapping</a></p>
</li>
<li>
<p><a href="#gavro">Allowing Non-Component Callers</a></p>
</li>
<li>
<p><a href="#giydx">Using Application-Scoped Resources</a></p>
</li>
<li>
<p><a href="#geqvg">Restrictions and Optimizations</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="giyck"></a><a id="GSDVG00182"></a><a id="statements"></a></p>
</div>
<div class="sect2">
<h3 id="_statements">Statements</h3>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#giyfu">Using an Initialization Statement</a></p>
</li>
<li>
<p><a href="#ghqrx">Setting a Statement Timeout</a></p>
</li>
<li>
<p><a href="#gktbf">Statement Leak Detection and Leaked Statement Reclamation</a></p>
</li>
<li>
<p><a href="#giyci">Statement Caching</a></p>
</li>
<li>
<p><a href="#giygg">Statement Tracing</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="giyfu"></a><a id="GSDVG00495"></a><a id="using-an-initialization-statement"></a></p>
</div>
<div class="sect3">
<h4 id="_using_an_initialization_statement">Using an Initialization Statement</h4>
<div class="paragraph">
<p>You can specify a statement that executes each time a physical
connection to the database is created (not reused) from a JDBC
connection pool. This is useful for setting request or session specific
properties and is suited for homogeneous requests in a single
application. Set the Init SQL attribute of the JDBC connection pool to
the SQL string to be executed in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter an Init SQL value in the Edit Connection Pool Advanced
Attributes page in the Administration Console. For more information,
click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--initsql</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>init-sql</code> option in the <code>asadmin set</code> command. For
example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.init-sql="sql-string"</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p><a id="ghqrx"></a><a id="GSDVG00496"></a><a id="setting-a-statement-timeout"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_setting_a_statement_timeout">Setting a Statement Timeout</h4>
<div class="paragraph">
<p>An abnormally long running JDBC query executed by an application may
leave it in a hanging state unless a timeout is explicitly set on the
statement. Setting a statement timeout guarantees that all queries
automatically time out if not completed within the specified period.
When statements are created, the <code>queryTimeout</code> is set according to the
statement timeout setting. This works only when the underlying JDBC
driver supports <code>queryTimeout</code> for <code>Statement</code>, <code>PreparedStatement</code>,
<code>CallableStatement</code>, and <code>ResultSet</code>.</p>
</div>
<div class="paragraph">
<p>You can specify a statement timeout in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter a Statement Timeout value in the Edit Connection Pool Advanced
Attributes page in the Administration Console. For more information,
click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--statementtimeout</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="gktbf"></a><a id="GSDVG00497"></a><a id="statement-leak-detection-and-leaked-statement-reclamation"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_statement_leak_detection_and_leaked_statement_reclamation">Statement Leak Detection and Leaked Statement Reclamation</h4>
<div class="paragraph">
<p>If statements are not closed by an application after use, it is possible
for the application to run out of cursors. Enabling statement leak
detection causes statements to be considered as leaked if they are not
closed within a specified period. Additionally, leaked statements can
reclaimed automatically.</p>
</div>
<div class="paragraph">
<p>To enable statement leak detection, set Statement Leak Timeout In
Seconds for the JDBC connection pool to a positive, nonzero value in one
of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify the <code>--statementleaktimeout</code> option in the
<code>create-jdbc-connection-pool</code> subcommand. For more information, see
<a href="../reference-manual/create-jdbc-connection-pool.html#GSRFM00036"><code>create-jdbc-connection-pool</code>(1)</a>.</p>
</li>
<li>
<p>Specify the <code>statement-leak-timeout-in-seconds</code> option in the <code>set</code>
subcommand. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set resources.jdbc-connection-pool.pool-name.statement-leak-timeout-in-seconds=300</pre>
</div>
</div>
<div class="paragraph">
<p>When selecting a value for Statement Leak Timeout In Seconds, make sure
that:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It is less than the Connection Leak Timeout; otherwise, the connection
could be closed before the statement leak is recognized.</p>
</li>
<li>
<p>It is greater than the Statement Timeout; otherwise, a long running
query could be mistaken as a statement leak.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>After enabling statement leak detection, enable leaked statement
reclamation by setting Reclaim Leaked Statements for the JDBC connection
pool to a <code>true</code> value in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Specify the <code>--statementleakreclaim=true</code> option in the
<code>create-jdbc-connection-pool</code> subcommand. For more information, see
<a href="../reference-manual/create-jdbc-connection-pool.html#GSRFM00036"><code>create-jdbc-connection-pool</code>(1)</a>.</p>
</li>
<li>
<p>Specify the <code>statement-leak-reclaim</code> option in the <code>set</code> subcommand.
For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set resources.jdbc-connection-pool.pool-name.statement-leak-reclaim=true</pre>
</div>
</div>
<div class="paragraph">
<p><a id="giyci"></a><a id="GSDVG00498"></a><a id="statement-caching"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_statement_caching">Statement Caching</h4>
<div class="paragraph">
<p>Statement caching stores statements, prepared statements, and callable
statements that are executed repeatedly by applications in a cache,
thereby improving performance. Instead of the statement being prepared
each time, the cache is searched for a match. The overhead of parsing
and creating new statements each time is eliminated.</p>
</div>
<div class="paragraph">
<p>Statement caching is usually a feature of the JDBC driver. The GlassFish
Server provides caching for drivers that do not support caching. To
enable this feature, set the Statement Cache Size for the JDBC
connection pool in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter a Statement Cache Size value in the Edit Connection Pool
Advanced Attributes page in the Administration Console. For more
information, click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--statementcachesize</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>statement-cache-size</code> option in the <code>asadmin set</code>
command. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.statement-cache-size=10</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>By default, this attribute is set to zero and the statement caching is
turned off. To enable statement caching, you can set any positive
nonzero value. The built-in cache eviction strategy is LRU-based (Least
Recently Used). When a connection pool is flushed, the connections in
the statement cache are recreated.</p>
</div>
<div class="paragraph">
<p><a id="giygg"></a><a id="GSDVG00499"></a><a id="statement-tracing"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_statement_tracing">Statement Tracing</h4>
<div class="paragraph">
<p>You can trace the SQL statements executed by applications that use a
JDBC connection pool. Set the SQL Trace Listeners attribute to a
comma-separated list of trace listener implementation classes in one of
the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter an SQL Trace Listeners value in the Edit Connection Pool
Advanced Attributes page in the Administration Console. For more
information, click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--sqltracelisteners</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>sql-trace-listeners</code> option in the <code>asadmin set</code> command.
For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.sql-trace-listeners=listeners</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>The GlassFish Server provides a public interface,
org.glassfish.api.jdbc.SQLTraceListener , that implements a means of
recording <code>SQLTraceRecord</code> objects. To make custom implementations of
this interface available to the GlassFish Server, place the
implementation classes in as-install`/lib`.</p>
</div>
<div class="paragraph">
<p>The GlassFish Server provides an SQL tracing logger to log the SQL
operations in the form of <code>SQLTraceRecord</code> objects in the <code>server.log</code>
file. The module name under which the SQL operation is logged is
<code>jakarta.enterprise.resource.sqltrace</code>. SQL traces are logged as FINE
messages along with the module name to enable easy filtering of the SQL
logs. A sample SQL trace record looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">[#|2009-11-27T15:46:52.202+0530|FINE|glassfish 6.0|jakarta.enterprise.resource.sqltrace.com.sun.gjc.util
|_ThreadID=29;_ThreadName=Thread-1;ClassName=com.sun.gjc.util.SQLTraceLogger;MethodName=sqlTrace;
|ThreadID=77 | ThreadName=p: thread-pool-1; w: 6 | TimeStamp=1259317012202
| ClassName=com.sun.gjc.spi.jdbc40.PreparedStatementWrapper40 | MethodName=executeUpdate
| arg[0]=insert into table1(colName) values(100) | arg[1]=columnNames | |#]</code></pre>
</div>
</div>
<div class="paragraph">
<p>This trace shows that an <code>executeUpdate(String sql, String columnNames)</code>
operation is being done.</p>
</div>
<div class="paragraph">
<p>When SQL statement tracing is enabled and JDBC connection pool
monitoring is enabled, GlassFish Server maintains a tracing cache of
recent queries and their frequency of use. The following JDBC connection
pool properties can be configured to control this cache and the
monitoring statistics available from it:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>time-to-keep-queries-in-minutes</code></dt>
<dd>
<p>Specifies how long in minutes to keep a query in the tracing cache,
tracking its frequency of use. The default value is 5 minutes.</p>
</dd>
<dt class="hdlist1"><code>number-of-top-queries-to-report</code></dt>
<dd>
<p>Specifies how many of the most used queries, in frequency order, are
listed the monitoring report. The default value is 10 queries.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Set these parameters in one of the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add them as properties in the Edit JDBC Connection Pool Properties
page in the Administration Console. For more information, click the Help
button in the Administration Console.</p>
</li>
<li>
<p>Specify them using the <code>--property</code> option in the
<code>create-jdbc-connection-pool</code> subcommand. For more information, see
<a href="../reference-manual/create-jdbc-connection-pool.html#GSRFM00036"><code>create-jdbc-connection-pool</code>(1)</a>.</p>
</li>
<li>
<p>Set them using the <code>set</code> subcommand. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set resources.jdbc-connection-pool.pool-name.property.time-to-keep-queries-in-minutes=10</pre>
</div>
</div>
<div class="paragraph">
<p><a id="giyeq"></a><a id="GSDVG00183"></a><a id="connections"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connections">Connections</h3>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#gktas">Transparent Pool Reconfiguration</a></p>
</li>
<li>
<p><a href="#giygl">Disabling Pooling</a></p>
</li>
<li>
<p><a href="#giydr">Associating Connections with Threads</a></p>
</li>
<li>
<p><a href="#giyfg">Custom Connection Validation</a></p>
</li>
<li>
<p><a href="#beams">Sharing Connections</a></p>
</li>
<li>
<p><a href="#gezfh">Marking Bad Connections</a></p>
</li>
<li>
<p><a href="#gipzl">Handling Invalid Connections</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="gktas"></a><a id="GSDVG00500"></a><a id="transparent-pool-reconfiguration"></a></p>
</div>
<div class="sect3">
<h4 id="_transparent_pool_reconfiguration">Transparent Pool Reconfiguration</h4>
<div class="paragraph">
<p>When the properties or attributes of a JDBC connection pool are changed,
the connection pool is destroyed and re-created. Normally, applications
using the connection pool must be redeployed as a consequence. This
restriction can be avoided by enabling transparent JDBC connection pool
reconfiguration. When this feature is enabled, applications do not need
to be redeployed. Instead, requests for a new connections are blocked
until the reconfiguration operation completes. Connection requests from
any in-flight transactions are served using the old pool configuration
so as to complete the transaction. Then, connections are created using
the pool&#8217;s new configuration, and any blocked connection requests are
served with connections from the re-created pool..</p>
</div>
<div class="paragraph">
<p>To enable transparent JDBC connection pool reconfiguration, set the
<code>dynamic-reconfiguration-wait-timeout-in-seconds</code> property of the JDBC
connection pool to a positive, nonzero value in one of the following
ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Add it as a property in the Edit JDBC Connection Pool Properties page
in the Administration Console. For more information, click the Help
button in the Administration Console.</p>
</li>
<li>
<p>Specify it using the <code>--property</code> option in the
<code>create-jdbc-connection-pool</code> subcommand. For more information, see
<a href="../reference-manual/create-jdbc-connection-pool.html#GSRFM00036"><code>create-jdbc-connection-pool</code>(1)</a>.</p>
</li>
<li>
<p>Set it using the <code>set</code> subcommand. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set resources.jdbc-connection-pool.pool-name.property.dynamic-reconfiguration-wait-timeout-in-seconds=15</pre>
</div>
</div>
<div class="paragraph">
<p>This property specifies the time in seconds to wait for in-use
connections to close and in-flight transactions to complete. Any
connections in use or transaction in flight past this time must be
retried.</p>
</div>
<div class="paragraph">
<p><a id="giygl"></a><a id="GSDVG00501"></a><a id="disabling-pooling"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_disabling_pooling">Disabling Pooling</h4>
<div class="paragraph">
<p>To disable connection pooling, set the Pooling attribute to false. The
default is true. You can enable or disable connection pooling in one of
the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter a Pooling value in the Edit Connection Pool Advanced Attributes
page in the Administration Console. For more information, click the Help
button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--pooling</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>pooling</code> option in the <code>asadmin set</code> command. For
example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.pooling=false</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>The <code>pooling</code> option and the system property
<code>com.sun.enterprise.connectors.SwitchoffACCConnectionPooling</code>, which
turns off connection pooling in the Application Client Container, do not
affect each other.</p>
</div>
<div class="paragraph">
<p>An exception is thrown if <code>associate-with-thread</code> is set to <code>true</code> and
pooling is disabled. An exception is thrown if you attempt to flush a
connection pool when pooling is disabled. A warning is logged if the
following attributes are used, because they are useful only in a pooled
environment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>connection-validation</code></p>
</li>
<li>
<p><code>validate-atmost-once-period</code></p>
</li>
<li>
<p><code>match-connections</code></p>
</li>
<li>
<p><code>max-connection-usage</code></p>
</li>
<li>
<p><code>idle-timeout</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="giydr"></a><a id="GSDVG00502"></a><a id="associating-connections-with-threads"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_associating_connections_with_threads">Associating Connections with Threads</h4>
<div class="paragraph">
<p>To associate connections with a thread, set the Associate With Thread
attribute to <code>true</code>. The default is <code>false</code>. A <code>true</code> setting allows
connections to be saved as <code>ThreadLocal</code> in the calling thread.
Connections get reclaimed only when the calling thread dies or when the
calling thread is not in use and the pool has run out of connections. If
the setting is <code>false</code>, the thread must obtain a connection from the
pool each time the thread requires a connection.</p>
</div>
<div class="paragraph">
<p>The Associate With Thread attribute associates connections with a thread
such that when the same thread is in need of connections, it can reuse
the connections already associated with that thread. In this case, the
overhead of getting connections from the pool is avoided. However, when
this value is set to <code>true</code>, you should verify that the value of the Max
Pool Size attribute is comparable to the Max Thread Pool Size attribute
of the thread pool. If the Max Thread Pool Size value is much higher
than the Max Pool Size value, a lot of time is spent associating
connections with a new thread after dissociating them from an older one.
Use this attribute in cases where the thread pool should reuse
connections to avoid this overhead.</p>
</div>
<div class="paragraph">
<p>You can set the Associate With Thread attribute in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter an Associate With Thread value in the Edit Connection Pool
Advanced Attributes page in the Administration Console. For more
information, click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--associatewiththread</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>associate-with-thread</code> option in the <code>asadmin set</code>
command. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.associate-with-thread=true</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p><a id="giyfg"></a><a id="GSDVG00503"></a><a id="custom-connection-validation"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_custom_connection_validation">Custom Connection Validation</h4>
<div class="paragraph">
<p>You can specify a custom implementation for Connection Validation that
is faster or optimized for a specific database. Set the Validation
Method attribute to the value <code>custom-validation</code>. (Other validation
methods available are <code>table</code> (the default), <code>auto-commit</code>, and
<code>meta-data</code>.) The GlassFish Server provides a public interface,
org.glassfish.api.jdbc.ConnectionValidation, which you can implement to
plug in your implementation. A new attribute, Validation Classname,
specifies the fully qualified name of the class that implements the
ConnectionValidation interface. The Validation Classname attribute is
required if Connection Validation is enabled and Validation Method is
set to Custom Validation.</p>
</div>
<div class="paragraph">
<p>To enable this feature, set Connection Validation, Validation Method,
and Validation Classname for the JDBC connection pool in one of the
following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Enter Connection Validation, Validation Method, and Validation
Classname values in the Edit Connection Pool Advanced Attributes page in
the Administration Console. You can select from among validation class
names for common databases in the Validation Classname field. For more
information, click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--isconnectionvalidatereq</code>, <code>--validationmethod</code>, and
<code>--validationclassname</code> options in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>is-connection-validation-required</code>,
<code>connection-validation-method</code>, and <code>validation-classname</code> options in
the <code>asadmin set</code> command. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.MyPool.is-connection-validation-required=true
asadmin set domain1.resources.jdbc-connection-pool.MyPool.connection-validation-method=custom-validation
asadmin set domain1.resources.jdbc-connection-pool.MyPool.validation-classname=impl-class</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>By default, optimized validation mechanisms are provided for DB2, Apache
Derby, MSSQL, MySQL, Oracle, PostgreSQL and Sybase databases.
Additionally, for JDBC 4.0 compliant database drivers, a validation
mechanism is provided that uses the <code>Connection.isValid(0)</code>
implementation.</p>
</div>
<div class="paragraph">
<p><a id="beams"></a><a id="GSDVG00504"></a><a id="sharing-connections"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_sharing_connections">Sharing Connections</h4>
<div class="paragraph">
<p>When multiple connections acquired by an application use the same JDBC
resource, the connection pool provides connection sharing within the
same transaction scope. For example, suppose Bean A starts a transaction
and obtains a connection, then calls a method in Bean B. If Bean B
acquires a connection to the same JDBC resource with the same sign-on
information, and if Bean A completes the transaction, the connection can
be shared.</p>
</div>
<div class="paragraph">
<p>Connections obtained through a resource are shared only if the resource
reference declared by the Java EE component allows it to be shareable.
This is specified in a component&#8217;s deployment descriptor by setting the
<code>res-sharing-scope</code> element to <code>Shareable</code> for the particular resource
reference. To turn off connection sharing, set <code>res-sharing-scope</code> to
<code>Unshareable</code>.</p>
</div>
<div class="paragraph">
<p>For general information about connections and JDBC URLs, see
"<a href="../administration-guide/jdbc.html#GSADG00015">Administering Database Connectivity</a>" in GlassFish
Server Open Source Edition Administration Guide.</p>
</div>
<div class="paragraph">
<p><a id="gezfh"></a><a id="GSDVG00505"></a><a id="marking-bad-connections"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_marking_bad_connections">Marking Bad Connections</h4>
<div class="paragraph">
<p>The <code>DataSource</code> implementation in the GlassFish Server provides a
<code>markConnectionAsBad</code> method. A marked bad connection is removed from
its connection pool when it is closed. The method signature is as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">public void markConnectionAsBad(java.sql.Connection con)</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">com.sun.appserv.jdbc.DataSource ds=
   (com.sun.appserv.jdbc.DataSource)context.lookup("dataSource");
Connection con = ds.getConnection();
Statement stmt = null;
try{
   stmt = con.createStatement();
   stmt.executeUpdate("Update");
}
catch (BadConnectionException e){
   ds.markConnectionAsBad(con) //marking it as bad for removal
}
finally{
   stmt.close();
   con.close(); //Connection will be destroyed during close.
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="gipzl"></a><a id="GSDVG00506"></a><a id="handling-invalid-connections"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_handling_invalid_connections">Handling Invalid Connections</h4>
<div class="paragraph">
<p>If a <code>ConnectionErrorOccured</code> event occurs, the GlassFish Server
considers the connection invalid and removes the connection from the
connection pool. Typically, a JDBC driver generates a
<code>ConnectionErrorOccured</code> event when it finds a <code>ManagedConnection</code>
object unusable. Reasons can be database failure, network failure with
the database, fatal problems with the connection pool, and so on.</p>
</div>
<div class="paragraph">
<p>If the <code>fail-all-connections</code> setting in the connection pool
configuration is set to <code>true</code>, and a single connection fails, all
connections are closed and recreated. If this setting is <code>false</code>,
individual connections are recreated only when they are used. The
default is <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The <code>is-connection-validation-required</code> setting specifies whether
connections have to be validated before being given to the application.
If a resource&#8217;s validation fails, it is destroyed, and a new resource is
created and returned. The default is <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The <code>prefer-validate-over-recreate</code> property specifies that validating
idle connections is preferable to closing them. This property has no
effect on non-idle connections. If set to <code>true</code>, idle connections are
validated during pool resizing, and only those found to be invalid are
destroyed and recreated. If <code>false</code>, all idle connections are destroyed
and recreated during pool resizing. The default is <code>false</code>.</p>
</div>
<div class="paragraph">
<p>You can set the <code>fail-all-connections</code>,
<code>is-connection-validation-required</code>, and <code>prefer-validate-over-recreate</code>
configuration settings during creation of a JDBC connection pool. Or,
you can use the <code>asadmin set</code> command to dynamically reconfigure a
setting. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">asadmin set server.resources.jdbc-connection-pool.JCPool1.fail-all-connections="true"
asadmin set server.resources.jdbc-connection-pool.JCPool1.is-connection-validation-required="true"
asadmin set server.resources.jdbc-connection-pool.JCPool1.property.prefer-validate-over-recreate="true"</code></pre>
</div>
</div>
<div class="paragraph">
<p>For details, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition
Reference Manual</a>.</p>
</div>
<div class="paragraph">
<p>The interface ValidatingManagedConnectionFactory exposes the method
<code>getInvalidConnections</code> to allow retrieval of the invalid connections.
The GlassFish Server checks if the JDBC driver implements this
interface, and if it does, invalid connections are removed when the
connection pool is resized.</p>
</div>
<div class="paragraph">
<p><a id="giyde"></a><a id="GSDVG00184"></a><a id="connection-wrapping"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_connection_wrapping">Connection Wrapping</h3>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#ghqxi">Wrapping Connections</a></p>
</li>
<li>
<p><a href="#beamt">Obtaining a Physical Connection From a Wrapped Connection</a></p>
</li>
<li>
<p><a href="#ggrum">Using the <code>Connection.unwrap()</code> Method</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="ghqxi"></a><a id="GSDVG00507"></a><a id="wrapping-connections"></a></p>
</div>
<div class="sect3">
<h4 id="_wrapping_connections">Wrapping Connections</h4>
<div class="paragraph">
<p>If the Wrap JDBC Objects option is <code>true</code> (the default), wrapped JDBC
objects are returned for <code>Statement</code>, <code>PreparedStatement</code>,
<code>CallableStatement</code>, <code>ResultSet</code>, and <code>DatabaseMetaData</code>.</p>
</div>
<div class="paragraph">
<p>This option ensures that <code>Statement.getConnection()</code> is the same as
<code>DataSource.getConnection()</code>. Therefore, this option should be <code>true</code>
when both <code>Statement.getConnection()</code> and <code>DataSource.getConnection()</code>
are done.</p>
</div>
<div class="paragraph">
<p>You can specify the Wrap JDBC Objects option in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check or uncheck the Wrap JDBC Objects box on the Edit Connection Pool
Advanced Attributes page in the Administration Console. For more
information, click the Help button in the Administration Console.</p>
</li>
<li>
<p>Specify the <code>--wrapjdbcobjects</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="beamt"></a><a id="GSDVG00508"></a><a id="obtaining-a-physical-connection-from-a-wrapped-connection"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_obtaining_a_physical_connection_from_a_wrapped_connection">Obtaining a Physical Connection From a Wrapped Connection</h4>
<div class="paragraph">
<p>The <code>DataSource</code> implementation in the GlassFish Server provides a
<code>getConnection</code> method that retrieves the JDBC driver&#8217;s <code>SQLConnection</code>
from the GlassFish Server&#8217;s <code>Connection</code> wrapper. The method signature
is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">public java.sql.Connection getConnection(java.sql.Connection con)
throws java.sql.SQLException</code></pre>
</div>
</div>
<div class="paragraph">
<p>For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="prettyprint highlight"><code class="language-oac_no_warn" data-lang="oac_no_warn">InitialContext ctx = new InitialContext();
com.sun.appserv.jdbc.DataSource ds = (com.sun.appserv.jdbc.DataSource)
   ctx.lookup("jdbc/MyBase");
Connection con = ds.getConnection();
Connection drivercon = ds.getConnection(con); //get physical connection from wrapper
// Do db operations.
// Do not close driver connection.
con.close(); // return wrapped connection to pool.</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="ggrum"></a><a id="GSDVG00509"></a><a id="using-the-connection.unwrap-method"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_the_code_connection_unwrap_code_method">Using the <code>Connection.unwrap()</code> Method</h4>
<div class="paragraph">
<p>Using the <code>Connection.unwrap()</code> method on a vendor-provided interface
returns an object or a wrapper object implementing the vendor-provided
interface, which the application can make use of to do vendor-specific
database operations. Use the <code>Connection.isWrapperFor()</code> method on a
vendor-provided interface to check whether the connection can provide an
implementation of the vendor-provided interface. Check the JDBC driver
vendor&#8217;s documentation for information on these interfaces.</p>
</div>
<div class="paragraph">
<p><a id="gavro"></a><a id="GSDVG00185"></a><a id="allowing-non-component-callers"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_allowing_non_component_callers">Allowing Non-Component Callers</h3>
<div class="paragraph">
<p>You can allow non-Java-EE components, such as servlet filters, lifecycle
modules, and third party persistence managers, to use this JDBC
connection pool. The returned connection is automatically enlisted with
the transaction context obtained from the transaction manager. Standard
Java EE components can also use such pools. Connections obtained by
non-component callers are not automatically closed at the end of a
transaction by the container. They must be explicitly closed by the
caller.</p>
</div>
<div class="paragraph">
<p>You can enable non-component callers in the following ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check the Allow Non Component Callers box on the Edit Connection Pool
Advanced Attributes page in the Administration Console. The default is
<code>false</code>. For more information, click the Help button in the
Administration Console.</p>
</li>
<li>
<p>Specify the <code>--allownoncomponentcallers</code> option in the
<code>asadmin create-jdbc-connection-pool</code> command. For more information, see
the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source Edition Reference Manual</a>.</p>
</li>
<li>
<p>Specify the <code>allow-non-component-callers</code> option in the <code>asadmin set</code>
command. For example:<br></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>asadmin set domain1.resources.jdbc-connection-pool.DerbyPool.allow-non-component-callers=true</pre>
</div>
</div>
<div class="paragraph">
<p>For more information, see the <a href="../reference-manual/toc.html#GSRFM">GlassFish Server Open Source
Edition Reference Manual</a>.
* Create a JDBC resource with a <code>__pm</code> suffix.</p>
</div>
<div class="paragraph">
<p>Accessing a <code>DataSource</code> using the <code>Synchronization.beforeCompletion()</code>
method requires setting Allow Non Component Callers to <code>true</code>. For more
information about the Transaction Synchronization Registry, see
<a href="transaction-service.html#gaxit">The Transaction Manager, the
Transaction Synchronization Registry, and <code>UserTransaction</code></a>.</p>
</div>
<div class="paragraph">
<p><a id="giydx"></a><a id="GSDVG00186"></a><a id="using-application-scoped-resources"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_using_application_scoped_resources">Using Application-Scoped Resources</h3>
<div class="paragraph">
<p>You can define an application-scoped database or other resource for an
enterprise application, web module, EJB module, connector module, or
application client module by supplying a <code>glassfish-resources.xml</code>
deployment descriptor file. For details, see
"<a href="../application-deployment-guide/deploying-applications.html#GSDPG00075">Application-Scoped Resources</a>" in GlassFish Server
Open Source Edition Application Deployment Guide.</p>
</div>
<div class="paragraph">
<p><a id="geqvg"></a><a id="GSDVG00187"></a><a id="restrictions-and-optimizations"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_restrictions_and_optimizations">Restrictions and Optimizations</h3>
<div class="paragraph">
<p>This section discusses restrictions and performance optimizations that
affect using the JDBC API.</p>
</div>
<div class="paragraph">
<p><a id="geqvy"></a><a id="GSDVG00510"></a><a id="disabling-stored-procedure-creation-on-sybase"></a></p>
</div>
<div class="sect3">
<h4 id="_disabling_stored_procedure_creation_on_sybase">Disabling Stored Procedure Creation on Sybase</h4>
<div class="paragraph">
<p>By default, DataDirect and Oracle JDBC drivers for Sybase databases
create a stored procedure for each parameterized <code>PreparedStatement</code>. On
the GlassFish Server, exceptions are thrown when primary key identity
generation is attempted. To disable the creation of these stored
procedures, set the property <code>PrepareMethod=direct</code> for the JDBC
connection pool.</p>
</div>
</div>
</div>
</div>
</div>

<hr />

<table width="90%" id="bottom-nav" cellspacing="0" cellpadding="0">
	<colgroup>
		<col width="12%"/>
		<col width="12%"/>
		<col width="*"/>
	</colgroup>
	<tr>		
		<td align="left">
		<a href="part-services-and-apis.html">
			<span class=" vector-font"><i class="fa fa-arrow-circle-left" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Previous</span>
		</a>
		</td>

		<td align="left">
		<a href="transaction-service.html">
			<span class="vector-font"><i class="fa fa-arrow-circle-right vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Next</span>
		</a>
		</td>

		<td align="right">
		<a href="toc.html">
			<span class="vector-font"><i class="fa fa-list vector-font" aria-hidden="true"></i></span>
			<span style="position:relative;top:-2px;">Contents</span>
		</a>
		</td>
	</tr>
</table>

<span id="copyright">
        <img src="img/eclipse_foundation_logo_tiny.png" height="20px" alt="Eclipse Foundation Logo" align="top"/>&nbsp;            
        <span >Copyright&nbsp;&copy;&nbsp;2019,&nbsp;Oracle&nbsp;and/or&nbsp;its&nbsp;affiliates.&nbsp;All&nbsp;rights&nbsp;reserved.</span>
</span>

<p align="center" class="beta">DRAFT</p>

</body>
</html>